// This is your Prisma schema file for NST-SDC-Portal
// GitHub Activity Tracking System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User model for club members
model User {
  id            String   @id @default(cuid())
  githubId      String   @unique
  username      String   @unique
  email         String?  @unique
  name          String?
  avatarUrl     String?
  bio           String?
  location      String?
  company       String?
  
  // Club-specific fields
  role          Role     @default(MEMBER)
  joinedAt      DateTime @default(now())
  isActive      Boolean  @default(true)
  
  // Relations
  commits       Commit[]
  pullRequests  PullRequest[]
  issues        Issue[]
  achievements  UserAchievement[]
  activityLogs  ActivityLog[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([githubId])
  @@index([username])
}

// Role enum for users
enum Role {
  ADMIN
  MEMBER
  MODERATOR
}

// Repository model
model Repository {
  id            String   @id @default(cuid())
  githubId      String   @unique
  name          String
  fullName      String   @unique
  description   String?
  url           String
  homepage      String?
  
  // Repository stats
  stars         Int      @default(0)
  forks         Int      @default(0)
  openIssues    Int      @default(0)
  watchers      Int      @default(0)
  
  language      String?
  isPrivate     Boolean  @default(false)
  isArchived    Boolean  @default(false)
  
  // Relations
  commits       Commit[]
  pullRequests  PullRequest[]
  issues        Issue[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([githubId])
  @@index([fullName])
}

// Commit model
model Commit {
  id            String   @id @default(cuid())
  sha           String   @unique
  message       String
  url           String
  
  // Author info
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Repository info
  repositoryId  String
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  additions     Int      @default(0)
  deletions     Int      @default(0)
  changedFiles  Int      @default(0)
  
  committedAt   DateTime
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([repositoryId])
  @@index([committedAt])
}

// Pull Request model
model PullRequest {
  id            String   @id @default(cuid())
  githubId      String   @unique
  number        Int
  title         String
  body          String?
  url           String
  
  state         PRState
  
  // Author info
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Repository info
  repositoryId  String
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  // PR stats
  additions     Int      @default(0)
  deletions     Int      @default(0)
  changedFiles  Int      @default(0)
  comments      Int      @default(0)
  reviewComments Int     @default(0)
  commits       Int      @default(0)
  
  createdAt     DateTime
  updatedAt     DateTime
  closedAt      DateTime?
  mergedAt      DateTime?
  
  @@index([userId])
  @@index([repositoryId])
  @@index([state])
}

enum PRState {
  OPEN
  CLOSED
  MERGED
}

// Issue model
model Issue {
  id            String   @id @default(cuid())
  githubId      String   @unique
  number        Int
  title         String
  body          String?
  url           String
  
  state         IssueState
  
  // Author info
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Repository info
  repositoryId  String
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  
  labels        Label[]  // Relation to Label model
  comments      Int      @default(0)
  
  createdAt     DateTime
  updatedAt     DateTime
  closedAt      DateTime?
  
  @@index([userId])
  @@index([repositoryId])
  @@index([state])
}

enum IssueState {
  OPEN
  CLOSED
}

model Label {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String?
  issues    Issue[]  // implicit many-to-many relation with Issue

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Achievement model
model Achievement {
  id            String   @id @default(cuid())
  name          String   @unique
  description   String
  icon          String?
  category      AchievementCategory
  points        Int      @default(0)
  
  // Criteria for unlocking
  criteria      String   // JSON string describing criteria
  
  users         UserAchievement[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum AchievementCategory {
  COMMITS
  PULL_REQUESTS
  ISSUES
  COLLABORATION
  STREAK
  MILESTONE
}

// User Achievement join table
model UserAchievement {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  unlockedAt    DateTime @default(now())
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

// Activity Log model for tracking daily activity
model ActivityLog {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  activityType  ActivityType
  metadata      String?  // JSON string for additional data
  
  date          DateTime @db.Date
  createdAt     DateTime @default(now())
  
  @@unique([userId, date, activityType])
  @@index([userId])
  @@index([date])
}

enum ActivityType {
  COMMIT
  PULL_REQUEST
  ISSUE
  REVIEW
  COMMENT
}
